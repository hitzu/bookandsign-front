name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    name: Build Project
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build project
        run: yarn build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://bookandsign-api.onrender.com' }}

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    environment: production
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://bookandsign-api.onrender.com' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Debug - Verify VERCEL_TOKEN Secret
        run: |
          echo "ðŸ” Checking VERCEL_TOKEN secret..."
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "âŒ ERROR: VERCEL_TOKEN is empty or not set"
            echo "Please check GitHub Secrets â†’ VERCEL_TOKEN"
            exit 1
          else
            TOKEN_LENGTH=${#VERCEL_TOKEN}
            TOKEN_PREFIX="${VERCEL_TOKEN:0:10}"
            TOKEN_SUFFIX="${VERCEL_TOKEN: -4}"
            echo "âœ… VERCEL_TOKEN is set"
            echo "   Token length: ${TOKEN_LENGTH} characters"
            echo "   Token starts with: ${TOKEN_PREFIX}..."
            echo "   Token ends with: ...${TOKEN_SUFFIX}"
            echo "   (Token value is hidden for security)"
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Debug - Verify Environment Variables
        run: |
          echo "ðŸ” Checking environment variables..."
          if [ -z "$NEXT_PUBLIC_API_URL" ]; then
            echo "âš ï¸  NEXT_PUBLIC_API_URL is not set"
            echo "   Will use default: https://bookandsign-api.onrender.com"
          else
            echo "âœ… NEXT_PUBLIC_API_URL is set"
            echo "   Value: $NEXT_PUBLIC_API_URL"
          fi
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      - name: Debug - Check Vercel Project Link Status
        run: |
          echo "ðŸ” Checking Vercel project link status..."
          if [ -f ".vercel/project.json" ]; then
            echo "âœ… .vercel/project.json exists"
            echo "Project configuration:"
            cat .vercel/project.json | jq '.' || cat .vercel/project.json
          else
            echo "âš ï¸  .vercel/project.json does not exist"
            echo "   Project may not be linked. 'vercel pull' will attempt to link it."
          fi

          if [ -f ".vercel/org.json" ]; then
            echo "âœ… .vercel/org.json exists"
            echo "Organization configuration:"
            cat .vercel/org.json | jq '.' || cat .vercel/org.json
          else
            echo "âš ï¸  .vercel/org.json does not exist"
          fi

      - name: Pull Vercel Environment Information
        run: |
          echo "ðŸ“¥ Pulling Vercel environment information..."
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Environment information pulled successfully"
        continue-on-error: true

      - name: Debug - Show Vercel Configuration After Pull
        if: success() || failure()
        run: |
          echo "ðŸ” Checking Vercel configuration after pull..."
          if [ -f ".vercel/project.json" ]; then
            echo "Project ID:"
            cat .vercel/project.json | jq -r '.projectId' 2>/dev/null || echo "Could not read project ID"
            echo "Org ID:"
            cat .vercel/org.json | jq -r '.orgId' 2>/dev/null || echo "Could not read org ID"
          fi

      - name: Build Project
        run: |
          echo "ðŸ”¨ Building project with Vercel..."
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Build completed successfully"
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://bookandsign-api.onrender.com' }}

      - name: Deploy Project to Vercel
        run: |
          echo "ðŸš€ Deploying project to Vercel..."
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
          echo "âœ… Deployment completed successfully"
